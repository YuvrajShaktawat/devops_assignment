pipeline {
    agent any
    
    parameters {
        choice(
            name: 'BRANCH_NAME',
            choices: ['main', 'develop', 'feature/terraform-setup', 'feature/jenkins-pipeline'],
            description: 'Select branch to deploy from'
        )
        booleanParam(
            name: 'DESTROY_INFRASTRUCTURE', 
            defaultValue: false, 
            description: 'Check this to destroy infrastructure instead of deploying'
        )
        string(
            name: 'AWS_REGION',
            defaultValue: 'ap-south-1',
            description: 'AWS Region for deployment'
        )
    }
    
    environment {
        AWS_ACCESS_KEY_ID     = credentials('aws-access-key-id')
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-access-key')
        AWS_DEFAULT_REGION    = "${params.AWS_REGION}"
        TF_IN_AUTOMATION      = 'true'
    }
    
    stages {
        stage('Checkout Code') {
            steps {
                script {
                    echo "Checking out code from branch: ${params.BRANCH_NAME}"
                    
                    // For first run without parameters, use main branch
                    def branchToCheckout = params.BRANCH_NAME ?: 'main'
                    
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: "*/${branchToCheckout}"]],
                        doGenerateSubmoduleConfigurations: false,
                        extensions: [
                            [$class: 'CleanBeforeCheckout']
                        ],
                        userRemoteConfigs: [[
                            credentialsId: 'Devops_git_User',
                            url: 'https://github.com/YuvrajShaktawat/devops_assignment.git'
                        ]]
                    ])
                    
                    echo "✓ Code checked out successfully from branch: ${branchToCheckout}"
                }
            }
        }
        
        stage('Stage 1: Deploy Infrastructure (IaC)') {
            when {
                expression { params.DESTROY_INFRASTRUCTURE == false }
            }
            steps {
                echo '═══════════════════════════════════════════════════════'
                echo 'STAGE 1: Deploy Infrastructure (IaC)'
                echo '═══════════════════════════════════════════════════════'
                
                dir('terraform') {
                    script {
                        // Step 1: Initialize IaC
                        echo 'Step 1.1: Initialize IaC'
                        
                        // Windows-compatible command
                        if (isUnix()) {
                            sh 'terraform init -reconfigure'
                        } else {
                            bat 'terraform init -reconfigure'
                        }
                        echo '✓ Terraform initialized'
                        
                        // Step 2: Deploy infrastructure
                        echo 'Step 1.2: Deploy infrastructure'
                        
                        if (isUnix()) {
                            sh 'terraform plan -out=tfplan'
                            sh 'terraform apply -auto-approve tfplan'
                        } else {
                            bat 'terraform plan -out=tfplan'
                            bat 'terraform apply -auto-approve tfplan'
                        }
                        echo '✓ Infrastructure deployed'
                        
                        // Step 3: Confirm EC2 creation
                        echo 'Step 1.3: Confirm EC2 creation'
                        
                        if (isUnix()) {
                            sh 'terraform show | grep "aws_instance.nginx_server"'
                        } else {
                            bat 'terraform show | findstr "aws_instance.nginx_server"'
                        }
                        echo '✓ EC2 instance creation confirmed'
                        
                        echo ''
                        echo '✓ STAGE 1 COMPLETED: Infrastructure deployed successfully'
                    }
                }
            }
        }
        
        stage('Stage 2: Configure EC2 & Deploy Application') {
            when {
                expression { params.DESTROY_INFRASTRUCTURE == false }
            }
            steps {
                echo '═══════════════════════════════════════════════════════'
                echo 'STAGE 2: Configure EC2 & Deploy Application'
                echo '═══════════════════════════════════════════════════════'
                
                dir('terraform') {
                    script {
                        // Get instance details
                        def instanceId = ''
                        def publicIp = ''
                        def privateIp = ''
                        
                        if (isUnix()) {
                            instanceId = sh(script: 'terraform output -raw instance_id', returnStdout: true).trim()
                            publicIp = sh(script: 'terraform output -raw instance_public_ip', returnStdout: true).trim()
                            privateIp = sh(script: 'terraform output -raw instance_private_ip', returnStdout: true).trim()
                        } else {
                            instanceId = bat(script: '@terraform output -raw instance_id', returnStdout: true).trim()
                            publicIp = bat(script: '@terraform output -raw instance_public_ip', returnStdout: true).trim()
                            privateIp = bat(script: '@terraform output -raw instance_private_ip', returnStdout: true).trim()
                        }
                        
                        echo "Instance ID: ${instanceId}"
                        echo "Public IP: ${publicIp}"
                        echo "Private IP: ${privateIp}"
                        
                        // User-data script handles all configuration
                        echo 'Step 2.1: Install NGINX - Handled by user-data script'
                        echo 'Step 2.2: Generate HTML dynamically - Handled by user-data script'
                        echo 'Step 2.3: Inject instance private IP - Handled by user-data script'
                        echo 'Step 2.4: Ensure NGINX runs on port 80 - Handled by user-data script'
                        
                        echo ''
                        echo 'Waiting for user-data script to complete...'
                        
                        // Wait for instance to be ready
                        def maxAttempts = 30
                        def attempt = 0
                        def instanceReady = false
                        
                        while (attempt < maxAttempts && !instanceReady) {
                            attempt++
                            echo "Checking instance status... (${attempt}/${maxAttempts})"
                            
                            def statusCheck = ''
                            try {
                                if (isUnix()) {
                                    statusCheck = sh(
                                        script: """
                                            aws ec2 describe-instance-status \
                                                --instance-ids ${instanceId} \
                                                --region ${AWS_DEFAULT_REGION} \
                                                --query 'InstanceStatuses[0].InstanceStatus.Status' \
                                                --output text 2>/dev/null || echo 'initializing'
                                        """,
                                        returnStdout: true
                                    ).trim()
                                } else {
                                    statusCheck = bat(
                                        script: """
                                            @aws ec2 describe-instance-status ^
                                                --instance-ids ${instanceId} ^
                                                --region ${AWS_DEFAULT_REGION} ^
                                                --query "InstanceStatuses[0].InstanceStatus.Status" ^
                                                --output text 2>nul || echo initializing
                                        """,
                                        returnStdout: true
                                    ).trim()
                                }
                            } catch (Exception e) {
                                statusCheck = 'initializing'
                            }
                            
                            if (statusCheck == 'ok') {
                                instanceReady = true
                                echo '✓ Instance status checks passed'
                            } else {
                                sleep(time: 5, unit: 'SECONDS')
                            }
                        }
                        
                        // Additional wait for NGINX installation
                        echo 'Waiting for user-data script to complete NGINX installation...'
                        sleep(time: 60, unit: 'SECONDS')
                        
                        echo ''
                        echo '✓ STAGE 2 COMPLETED: EC2 configured and application deployed'
                    }
                }
            }
        }
        
        stage('Stage 3: Deployment Validation') {
            when {
                expression { params.DESTROY_INFRASTRUCTURE == false }
            }
            steps {
                echo '═══════════════════════════════════════════════════════'
                echo 'STAGE 3: Deployment Validation'
                echo '═══════════════════════════════════════════════════════'
                
                dir('terraform') {
                    script {
                        // Retrieve EC2 public IP
                        echo 'Step 3.1: Retrieve EC2 public IP or DNS'
                        
                        def publicIp = ''
                        def publicDns = ''
                        
                        if (isUnix()) {
                            publicIp = sh(script: 'terraform output -raw instance_public_ip', returnStdout: true).trim()
                            publicDns = sh(script: 'terraform output -raw instance_public_dns', returnStdout: true).trim()
                        } else {
                            publicIp = bat(script: '@terraform output -raw instance_public_ip', returnStdout: true).trim()
                            publicDns = bat(script: '@terraform output -raw instance_public_dns', returnStdout: true).trim()
                        }
                        
                        echo "EC2 Public IP: ${publicIp}"
                        echo "EC2 Public DNS: ${publicDns}"
                        echo '✓ EC2 details retrieved'
                        
                        // Validate using curl
                        echo ''
                        echo 'Step 3.2: Validate using curl from Jenkins'
                        echo "Executing: curl http://${publicIp}"
                        
                        def validationSuccess = false
                        def maxAttempts = 24
                        def attempt = 0
                        
                        while (attempt < maxAttempts && !validationSuccess) {
                            attempt++
                            echo "Validation attempt ${attempt}/${maxAttempts}..."
                            
                            def httpCode = ''
                            def response = ''
                            
                            try {
                                if (isUnix()) {
                                    httpCode = sh(
                                        script: "curl -s -o /dev/null -w '%{http_code}' http://${publicIp} --connect-timeout 5 --max-time 10 || echo '000'",
                                        returnStdout: true
                                    ).trim()
                                } else {
                                    // For Windows, use PowerShell
                                    httpCode = powershell(
                                        script: """
                                            try {
                                                \$response = Invoke-WebRequest -Uri "http://${publicIp}" -TimeoutSec 10 -UseBasicParsing
                                                \$response.StatusCode
                                            } catch {
                                                Write-Output "000"
                                            }
                                        """,
                                        returnStdout: true
                                    ).trim()
                                }
                                
                                if (httpCode == '200') {
                                    echo "✓ HTTP Response Code: ${httpCode}"
                                    
                                    // Get response content
                                    if (isUnix()) {
                                        response = sh(script: "curl -s http://${publicIp}", returnStdout: true).trim()
                                    } else {
                                        response = powershell(
                                            script: """
                                                \$response = Invoke-WebRequest -Uri "http://${publicIp}" -UseBasicParsing
                                                \$response.Content
                                            """,
                                            returnStdout: true
                                        ).trim()
                                    }
                                    
                                    echo ''
                                    echo 'Response received from EC2:'
                                    echo '─────────────────────────────────────────────────────'
                                    echo response.take(300)
                                    echo '─────────────────────────────────────────────────────'
                                    
                                    // Validate content
                                    if (response.contains('CSA DevOps Exam')) {
                                        echo "✓ Response contains: 'CSA DevOps Exam'"
                                    } else {
                                        error "✗ Response missing: 'CSA DevOps Exam'"
                                    }
                                    
                                    if (response.contains('Instance IP:')) {
                                        echo "✓ Response contains: 'Instance IP:'"
                                    } else {
                                        error "✗ Response missing: 'Instance IP:'"
                                    }
                                    
                                    validationSuccess = true
                                }
                            } catch (Exception e) {
                                echo "Request failed: ${e.message}"
                            }
                            
                            if (!validationSuccess && attempt < maxAttempts) {
                                sleep(time: 5, unit: 'SECONDS')
                            }
                        }
                        
                        if (!validationSuccess) {
                            error 'Deployment validation failed: NGINX not responding'
                        }
                        
                        echo ''
                        echo '✓ STAGE 3 COMPLETED: Deployment validated successfully'
                    }
                }
            }
        }
        
        stage('Stage 4: Output Results') {
            when {
                expression { params.DESTROY_INFRASTRUCTURE == false }
            }
            steps {
                echo '═══════════════════════════════════════════════════════'
                echo 'STAGE 4: Output Results'
                echo '═══════════════════════════════════════════════════════'
                
                dir('terraform') {
                    script {
                        def publicIp = ''
                        def publicDns = ''
                        def instanceId = ''
                        
                        if (isUnix()) {
                            publicIp = sh(script: 'terraform output -raw instance_public_ip', returnStdout: true).trim()
                            publicDns = sh(script: 'terraform output -raw instance_public_dns', returnStdout: true).trim()
                            instanceId = sh(script: 'terraform output -raw instance_id', returnStdout: true).trim()
                        } else {
                            publicIp = bat(script: '@terraform output -raw instance_public_ip', returnStdout: true).trim()
                            publicDns = bat(script: '@terraform output -raw instance_public_dns', returnStdout: true).trim()
                            instanceId = bat(script: '@terraform output -raw instance_id', returnStdout: true).trim()
                        }
                        
                        echo ''
                        echo '╔════════════════════════════════════════════════════════════╗'
                        echo '║              DEPLOYMENT SUCCESSFUL                         ║'
                        echo '╠════════════════════════════════════════════════════════════╣'
                        echo "║  Application URL:  http://${publicIp}                      ║"
                        echo "║  EC2 Public IP:    ${publicIp}                             ║"
                        echo "║  EC2 Public DNS:   ${publicDns}                            ║"
                        echo "║  Instance ID:      ${instanceId}                           ║"
                        echo '║  Status: ✓ Deployment completed successfully              ║'
                        echo '╚════════════════════════════════════════════════════════════╝'
                        echo ''
                        echo '✓ STAGE 4 COMPLETED: Results printed'
                        echo ''
                        echo 'All 4 mandatory stages completed successfully!'
                        echo "Access your application at: http://${publicIp}"
                    }
                }
            }
        }
        
        stage('Destroy Infrastructure') {
            when {
                expression { params.DESTROY_INFRASTRUCTURE == true }
            }
            steps {
                echo '═══════════════════════════════════════════════════════'
                echo 'DESTROY MODE: Destroying Infrastructure'
                echo '═══════════════════════════════════════════════════════'
                
                dir('terraform') {
                    script {
                        if (isUnix()) {
                            sh 'terraform init -reconfigure'
                            sh 'terraform destroy -auto-approve'
                        } else {
                            bat 'terraform init -reconfigure'
                            bat 'terraform destroy -auto-approve'
                        }
                        echo '✓ Infrastructure destroyed successfully'
                    }
                }
            }
        }
    }
    
    post {
        success {
            script {
                def destroyMode = params.DESTROY_INFRASTRUCTURE ?: false
                if (destroyMode) {
                    echo ''
                    echo '╔════════════════════════════════════════════════╗'
                    echo '║   Infrastructure Destroyed Successfully       ║'
                    echo '╚════════════════════════════════════════════════╝'
                } else {
                    echo ''
                    echo '╔════════════════════════════════════════════════╗'
                    echo '║   Pipeline Completed Successfully             ║'
                    echo '║   All 4 Mandatory Stages Executed              ║'
                    echo '╚════════════════════════════════════════════════╝'
                }
            }
        }
        
        failure {
            echo ''
            echo '╔════════════════════════════════════════════════╗'
            echo '║   Pipeline Failed                              ║'
            echo '╚════════════════════════════════════════════════╝'
            echo ''
            echo 'Check the logs above for error details'
        }
        
        always {
            script {
                // Archive Terraform outputs (Windows-compatible)
                dir('terraform') {
                    try {
                        if (isUnix()) {
                            sh '''
                                if [ -f "tfplan" ]; then
                                    terraform show -json tfplan > tfplan.json 2>/dev/null || true
                                fi
                            '''
                        } else {
                            bat '''
                                @echo off
                                if exist tfplan (
                                    terraform show -json tfplan > tfplan.json 2>nul
                                )
                            '''
                        }
                        archiveArtifacts artifacts: 'tfplan.json', allowEmptyArchive: true
                    } catch (Exception e) {
                        echo "Could not archive artifacts: ${e.message}"
                    }
                }
            }
        }
    }
}
