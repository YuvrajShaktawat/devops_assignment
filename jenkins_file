pipeline {
    agent any
    
    parameters {
        choice(
            name: 'BRANCH_NAME',
            choices: ['dev', 'feature/terraform', 'feature/jenkins', 'feature/nginx-userdata', 'main'],
            description: 'Select branch to deploy from'
        )
        booleanParam(
            name: 'DESTROY_INFRASTRUCTURE', 
            defaultValue: false, 
            description: 'Check this to destroy infrastructure instead of deploying'
        )
        string(
            name: 'AWS_REGION',
            defaultValue: 'ap-south-1',
            description: 'AWS Region for deployment'
        )
    }
    
    environment {
        AWS_ACCESS_KEY_ID     = credentials('aws-access-key-id')
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-access-key')
        AWS_DEFAULT_REGION    = "${params.AWS_REGION}"
        TF_IN_AUTOMATION      = 'true'
    }
    
    stages {
        stage('Checkout Code') {
            steps {
                script {
                    echo "Checking out code from branch: ${params.BRANCH_NAME}"
                    
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: "*/${params.BRANCH_NAME}"]],
                        doGenerateSubmoduleConfigurations: false,
                        extensions: [
                            [$class: 'CleanBeforeCheckout']
                        ],
                        userRemoteConfigs: [[
                            credentialsId: 'Devops_git_User',
                            url: 'https://github.com/YuvrajShaktawat/devops_assignment.git'
                        ]]
                    ])
                    
                    echo "✓ Code checked out successfully from branch: ${params.BRANCH_NAME}"
                }
            }
        }
        
        stage('Stage 1: Deploy Infrastructure (IaC)') {
            when {
                expression { params.DESTROY_INFRASTRUCTURE == false }
            }
            steps {
                echo '═══════════════════════════════════════════════════════'
                echo 'STAGE 1: Deploy Infrastructure (IaC)'
                echo '═══════════════════════════════════════════════════════'
                
                dir('terraform') {
                    script {
                        // Step 1: Initialize IaC
                        echo 'Step 1.1: Initialize IaC'
                        sh 'terraform init -reconfigure'
                        echo '✓ Terraform initialized'
                        
                        // Step 2: Deploy infrastructure
                        echo 'Step 1.2: Deploy infrastructure'
                        sh 'terraform plan -out=tfplan'
                        sh 'terraform apply -auto-approve tfplan'
                        echo '✓ Infrastructure deployed'
                        
                        // Step 3: Confirm EC2 creation
                        echo 'Step 1.3: Confirm EC2 creation'
                        sh '''
                            echo "Verifying EC2 instance creation..."
                            terraform show | grep "aws_instance.nginx_server"
                        '''
                        echo '✓ EC2 instance creation confirmed'
                        
                        echo ''
                        echo '✓ STAGE 1 COMPLETED: Infrastructure deployed successfully'
                    }
                }
            }
        }
        
        stage('Stage 2: Configure EC2 & Deploy Application') {
            when {
                expression { params.DESTROY_INFRASTRUCTURE == false }
            }
            steps {
                echo '═══════════════════════════════════════════════════════'
                echo 'STAGE 2: Configure EC2 & Deploy Application'
                echo '═══════════════════════════════════════════════════════'
                
                dir('terraform') {
                    script {
                        // Get instance details
                        def instanceId = sh(
                            script: 'terraform output -raw instance_id',
                            returnStdout: true
                        ).trim()
                        
                        def publicIp = sh(
                            script: 'terraform output -raw instance_public_ip',
                            returnStdout: true
                        ).trim()
                        
                        def privateIp = sh(
                            script: 'terraform output -raw instance_private_ip',
                            returnStdout: true
                        ).trim()
                        
                        echo "Instance ID: ${instanceId}"
                        echo "Public IP: ${publicIp}"
                        echo "Private IP: ${privateIp}"
                        
                        // User-data script handles all these steps automatically:
                        echo 'Step 2.1: Install NGINX - Handled by user-data script'
                        echo 'Step 2.2: Generate HTML dynamically - Handled by user-data script'
                        echo 'Step 2.3: Inject instance private IP - Handled by user-data script'
                        echo 'Step 2.4: Ensure NGINX runs on port 80 - Handled by user-data script'
                        
                        // Wait for user-data script to complete
                        echo ''
                        echo 'Waiting for user-data script to complete installation and configuration...'
                        
                        // Check instance status
                        def maxAttempts = 30
                        def attempt = 0
                        def instanceReady = false
                        
                        while (attempt < maxAttempts && !instanceReady) {
                            attempt++
                            echo "Checking instance status... (Attempt ${attempt}/${maxAttempts})"
                            
                            def statusCheck = sh(
                                script: """
                                    aws ec2 describe-instance-status \
                                        --instance-ids ${instanceId} \
                                        --region ${AWS_DEFAULT_REGION} \
                                        --query 'InstanceStatuses[0].InstanceStatus.Status' \
                                        --output text 2>/dev/null || echo 'initializing'
                                """,
                                returnStdout: true
                            ).trim()
                            
                            if (statusCheck == 'ok') {
                                instanceReady = true
                                echo '✓ Instance status checks passed'
                            } else {
                                echo "Instance status: ${statusCheck}"
                                sleep(time: 5, unit: 'SECONDS')
                            }
                        }
                        
                        // Additional wait for user-data script
                        echo 'Waiting for user-data script to complete NGINX installation...'
                        sleep(time: 60, unit: 'SECONDS')
                        
                        echo ''
                        echo '✓ STAGE 2 COMPLETED: EC2 configured and application deployed'
                        echo "  - NGINX installed: ✓"
                        echo "  - HTML generated with dynamic content: ✓"
                        echo "  - Instance private IP (${privateIp}) injected: ✓"
                        echo "  - NGINX running on port 80: ✓"
                    }
                }
            }
        }
        
        stage('Stage 3: Deployment Validation') {
            when {
                expression { params.DESTROY_INFRASTRUCTURE == false }
            }
            steps {
                echo '═══════════════════════════════════════════════════════'
                echo 'STAGE 3: Deployment Validation'
                echo '═══════════════════════════════════════════════════════'
                
                dir('terraform') {
                    script {
                        // Step 1: Retrieve EC2 public IP or DNS
                        echo 'Step 3.1: Retrieve EC2 public IP or DNS'
                        
                        def publicIp = sh(
                            script: 'terraform output -raw instance_public_ip',
                            returnStdout: true
                        ).trim()
                        
                        def publicDns = sh(
                            script: 'terraform output -raw instance_public_dns',
                            returnStdout: true
                        ).trim()
                        
                        echo "EC2 Public IP: ${publicIp}"
                        echo "EC2 Public DNS: ${publicDns}"
                        echo '✓ EC2 details retrieved'
                        
                        // Step 2: Validate using curl from Jenkins
                        echo ''
                        echo 'Step 3.2: Validate using curl from Jenkins'
                        echo "Executing: curl http://${publicIp}"
                        
                        def validationSuccess = false
                        def maxAttempts = 24
                        def attempt = 0
                        
                        while (attempt < maxAttempts && !validationSuccess) {
                            attempt++
                            echo "Validation attempt ${attempt}/${maxAttempts}..."
                            
                            def httpCode = sh(
                                script: "curl -s -o /dev/null -w '%{http_code}' http://${publicIp} --connect-timeout 5 --max-time 10 || echo '000'",
                                returnStdout: true
                            ).trim()
                            
                            if (httpCode == '200') {
                                echo "✓ HTTP Response Code: ${httpCode}"
                                
                                // Get the actual response content
                                def response = sh(
                                    script: "curl -s http://${publicIp}",
                                    returnStdout: true
                                ).trim()
                                
                                echo ''
                                echo 'Response received from EC2:'
                                echo '─────────────────────────────────────────────────────'
                                echo response.take(500) // Show first 500 characters
                                echo '─────────────────────────────────────────────────────'
                                
                                // Validate required content
                                echo ''
                                echo 'Validating response content...'
                                
                                if (response.contains('CSA DevOps Exam')) {
                                    echo "✓ Response contains: 'CSA DevOps Exam'"
                                } else {
                                    error "✗ Response does NOT contain required text: 'CSA DevOps Exam'"
                                }
                                
                                if (response.contains('Instance IP:')) {
                                    echo "✓ Response contains: 'Instance IP:'"
                                } else {
                                    error "✗ Response does NOT contain required text: 'Instance IP:'"
                                }
                                
                                validationSuccess = true
                                
                            } else {
                                echo "HTTP Response Code: ${httpCode} (Expected: 200)"
                                if (attempt < maxAttempts) {
                                    echo "Retrying in 5 seconds..."
                                    sleep(time: 5, unit: 'SECONDS')
                                }
                            }
                        }
                        
                        if (!validationSuccess) {
                            error 'Deployment validation failed: NGINX not responding after maximum attempts'
                        }
                        
                        echo ''
                        echo '✓ STAGE 3 COMPLETED: Deployment validated successfully'
                        echo "  - EC2 Public IP retrieved: ${publicIp}"
                        echo "  - curl validation passed: ✓"
                        echo "  - Response contains 'CSA DevOps Exam': ✓"
                        echo "  - Response contains 'Instance IP:': ✓"
                    }
                }
            }
        }
        
        stage('Stage 4: Output Results') {
            when {
                expression { params.DESTROY_INFRASTRUCTURE == false }
            }
            steps {
                echo '═══════════════════════════════════════════════════════'
                echo 'STAGE 4: Output Results'
                echo '═══════════════════════════════════════════════════════'
                
                dir('terraform') {
                    script {
                        // Retrieve final outputs
                        def publicIp = sh(
                            script: 'terraform output -raw instance_public_ip',
                            returnStdout: true
                        ).trim()
                        
                        def publicDns = sh(
                            script: 'terraform output -raw instance_public_dns',
                            returnStdout: true
                        ).trim()
                        
                        def instanceId = sh(
                            script: 'terraform output -raw instance_id',
                            returnStdout: true
                        ).trim()
                        
                        // Print application URL
                        echo ''
                        echo '╔════════════════════════════════════════════════════════════╗'
                        echo '║              DEPLOYMENT SUCCESSFUL                         ║'
                        echo '╠════════════════════════════════════════════════════════════╣'
                        echo '║                                                            ║'
                        echo "║  Application URL:  http://${publicIp.padRight(32)} ║"
                        echo "║  EC2 Public IP:    ${publicIp.padRight(37)} ║"
                        echo "║  EC2 Public DNS:   ${publicDns.padRight(37)} ║"
                        echo "║  Instance ID:      ${instanceId.padRight(37)} ║"
                        echo '║                                                            ║'
                        echo '║  Status: ✓ Deployment completed successfully              ║'
                        echo '║                                                            ║'
                        echo '╚════════════════════════════════════════════════════════════╝'
                        echo ''
                        
                        // Indicate successful deployment
                        echo '✓ STAGE 4 COMPLETED: Results printed'
                        echo ''
                        echo 'All 4 mandatory stages completed successfully!'
                        echo ''
                        echo 'Stage Summary:'
                        echo '  1. Deploy Infrastructure (IaC)          - ✓ COMPLETED'
                        echo '  2. Configure EC2 & Deploy Application   - ✓ COMPLETED'
                        echo '  3. Deployment Validation                - ✓ COMPLETED'
                        echo '  4. Output Results                       - ✓ COMPLETED'
                        echo ''
                        echo "Access your application at: http://${publicIp}"
                    }
                }
            }
        }
        
        stage('Destroy Infrastructure') {
            when {
                expression { params.DESTROY_INFRASTRUCTURE == true }
            }
            steps {
                echo '═══════════════════════════════════════════════════════'
                echo 'DESTROY MODE: Destroying Infrastructure'
                echo '═══════════════════════════════════════════════════════'
                
                dir('terraform') {
                    script {
                        sh 'terraform init -reconfigure'
                        sh 'terraform destroy -auto-approve'
                        echo '✓ Infrastructure destroyed successfully'
                    }
                }
            }
        }
    }
    
    post {
        success {
            script {
                if (params.DESTROY_INFRASTRUCTURE) {
                    echo ''
                    echo '╔════════════════════════════════════════════════╗'
                    echo '║   Infrastructure Destroyed Successfully       ║'
                    echo '╚════════════════════════════════════════════════╝'
                } else {
                    echo ''
                    echo '╔════════════════════════════════════════════════╗'
                    echo '║   Pipeline Completed Successfully             ║'
                    echo '║   All 4 Mandatory Stages Executed              ║'
                    echo '╚════════════════════════════════════════════════╝'
                }
            }
        }
        
        failure {
            echo ''
            echo '╔════════════════════════════════════════════════╗'
            echo '║   Pipeline Failed                              ║'
            echo '╚════════════════════════════════════════════════╝'
            echo ''
            echo 'Check the logs above for error details'
        }
        
        always {
            script {
                // Archive Terraform outputs
                dir('terraform') {
                    sh '''
                        if [ -f "tfplan" ]; then
                            terraform show -json tfplan > tfplan.json 2>/dev/null || true
                        fi
                    '''
                    archiveArtifacts artifacts: 'tfplan.json', allowEmptyArchive: true
                }
            }
        }
    }
}
